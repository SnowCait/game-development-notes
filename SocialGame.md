# ソーシャルゲーム開発

## ディレクトリ構成
* root
  * master
  * api
  * realtime
  * multi
  * batch
  * admin
  * infra
  * document
  * ci
    * Jenkinsfiles

## クライアント
* 解析されることを念頭に置く
  * 本番アプリのコードにデバッグ用コードは含めない `#if DEBUG`
* アセットの容量はファイル毎に管理できるようにしておく

## サーバー
* 個数のあるものは上限（と下限）を設定する。
* ゲーム内通貨もアイテムとして扱った方が楽かも。
* ヘルスチェック用 API を用意しておく
* 複数クライアントバージョン対応
  * API 単位でクライアントのバージョンを基にアクセス権限を調整する仕組み
* `if (is_production())` のようなコードは本番環境固有のバグが発生しやすいので極力書かずなるべく共通コードにする
  * `ENVIRONMENT === 'production'` は対応したい環境が増えたときに全部いじらないといけなくなるので絶対書いちゃダメ
  * 設定ファイルで機能ごとに ON/OFF 管理する

## 共通
* Swagger 導入
  * API ドキュメント
  * バリデーション
* ユーザーが見えるところ（ URL, クライアントのソースコード）にプロジェクト名を使わない

## 要設計
* クライアント/サーバーのコード
  * なるべくクライアントで処理して、サーバーは最低限の更新処理のみ行う
    * メリット：必要な処理を必要な側で行うのでロジックがすっきりする
    * デメリット：ちょっとした修正にストアを通したクライアントの更新が必要になってしまう
  * なるべくサーバーで処理して、クライアントは描画のみを行う
    * メリット：クライアントの更新なしで機能追加やバグ修正ができる
    * デメリット：サーバー負荷が高くなる
* 例外・エラー
  * 独自エラーコードを定義する際は HTTP ステータスと混じらないように4桁以上にするか文字列にする
* バリデーション
* [ログ](Log.md)
  * デバッグにも使えるので優先的に導入する
* ベンチマーク
  * 普段から計測したいので優先的に導入する
* デバッグコマンド
  * サーバーはデプロイしない or ユーザー判定して弾く
  * クライアントはバイナリいじったら有効にできてしまうのでそもそもコード自体含めない方が良い
* 時刻
  * NTP
  * MySQL 側で `NOW()` 関数を使うと少し負荷が高いのとデバッグしづらくなるので PHP から渡す
  * 現在時刻を変更するデバッグコマンド
    * 外部ストレージは影響を受けやすいので注意（ DynamoDB で TTL を設定すると自動削除されるなど）
* 共通コード（親クラスや trait などで作成）
  * ページャ
* メンテナンス運用
  * 全体メンテナンス
    * 定期 or 不定期
    * パーティションで消せない不要データ削除
    * メンテ時に行うアップデートの定義
  * 機能メンテナンス
* 開発環境
  * 個人/デバッグ/ステージング/本番どこまで用意するか
  * 環境の関係性が一目で分かる資料（プランナーや新卒が見ても分かるもの）
* ユーザー認証
  * ゲーム本体は認証が必要
  * ヘルスチェックや外部コラボなどの API や Web ページは認証は不要
  * 両方が作れるようにしておく（コントローラーの基底クラスを分ける？）
* ステージングにあげたものを本番にもあげる
  * お知らせなどデータを環境をまたいでそのまま持っていきたい
* ドメイン
  * サブドメインのルール
* セキュリティ
  * パスワードやトークンの管理
* デフォルト値を設定する場合は安全に寄せる
  * 設定し忘れたときに事故らないようにする
    * DB の接続先はローカル
    * 環境指定は本番（コミットしない方が良いが）

## 課金設計
### 方針
全てアイテムとして扱う。複数種類のアイテムをセット販売できるようにする。  
効果を即適用したい場合はアイテムとして付与したのち使用させる。

### CSV
`Item.csv`, `Payment.csv`, `Payment_items.csv`

## コミュニケーション
最近はスタンプのみでのコミュニケーションが主流。
* NGワードの設定をしなくてよい
* 出会い系の考慮をしなくてよい
* スタンプを各言語対応することで海外ユーザーとコミュニケーションがとれる

## 機能
* ユーザー
  * 認証
* フォロー（申請あり/なし）
* ギルド
* クエスト
* ミッション
* ログインボーナス
* アイテム
  * ガチャ
  * ショップ
  * 交換所
  * プレゼント
  * 補填
* 装備
  * 保護
* 箱庭
* パーティ
* マルチルーム
* 強化進化
* メンテナンス（ユーザーの権限次第で回避）
* 通知
* 設定
* 4コマ
* ヘルプ
* TIPS（ローディング中に表示されるやつ）

### ゲーム固有でなさそうなもの
* ユーザー
* ガチャ
* アイテム
* 交換所
* プレゼント
* ログインボーナス
* フォロー
* 箱庭
* メンテナンス

### プラットフォーム依存
* 認証
* 課金（ショップ）

## 補填
* 指定期間にログインしたユーザーに配布
  * マスターデータや DB に配布情報を載せてユーザーがログインしたときに配る（これが無駄なデータ増えなくて良さそう）
  * 対象ユーザーを抽出してバッチでプレゼントに積む

## 課金
* ISO 基準の国名コードや通貨コードを使う
* キャッシュはなるべく避けた方がいいかも

## コード自動生成
* 生成されたファイルにコメントで生成元ファイル名を入れておく `Generated by ~`
* コミットフックや CI を利用して自動で実行する
  * 実行に時間がかかるようであれば独立したジョブを用意して push や　merge をトリガーに PR 送る

## 全体
* プロジェクトコードを URL や API などに含めない（基本的にはソースにも書かない）

## テスト
* シャーディングテーブルへのマルチトランザクション

## 負荷テスト
* プレイヤーの行動ログから自動実行する仕組み
  * 負荷テストやデバッグに使える

## デバッグ
* API のリクエスト時に `?mode=debug` で受け付けるようにしておくと便利かも（デバッグ環境以外では input のところでエラーにする）

## バグ
* リリース後のバグ修正はお知らせに掲載するかの基準を決めておく
  * お知らせに載せるバグはコミットから自動収集できると望ましい

## ログ
* Kibana, fluentd, BigQuery
* LTSV, JSON
* ディレクトリはデプロイ時に予め作成しておく
  * ログ収集ツールからも参照されるのでアプリ側で勝手に作成しない
  * アプリのコードがすっきりする

## ライブラリのアップデート
* アップデートがあった際に RSS から拾って自動的に通知する仕組みを作る
  * GitHub/Redmine/JIRA に Issue を立てる
  * Slack にチャンネルを作って流す

## ライセンス管理
* ライセンス表記の必要なものは一覧にしておく

## マスターデータ
* プランナーが定義する Excel(SpreadSheet) から CSV/JSON を出力する際に複数のシートを1つに統合あるいは1つのシートを複数のファイルに分割できる仕組みを作る
```
[characters.xlsx]
id,name(forDev or ja-jp),description(forDev or ja-jp)
[characters_name_localize.xlsx]
id,ja-jp,en-us
[characters_description_localize.xlsx]
id,ja-jp,en-us
```
```
[characters.csv]
id,name.ja-jp,name.en-us,description.ja-jp,description.en-us
```
```
[characters.json]
{
  "id": 1,
  "name": {
    "ja-jp": ""
    "en-us": ""
  }
  "description": {
    "ja-jp": ""
    "en-us": ""
  }
}
```
入れ子にするデータは外部コンフィグで設定できるようにするかファイルの命名規則を決めて元データに持たせる
```
[characters.xlsx]
id,name[id,characters_name_localize.id],description[id,characters_description_localize.id]
[characters_name_localize.xlsx]
id,ja-jp,en-us
[characters_description_localize.xlsx]
id,ja-jp,en-us
```
