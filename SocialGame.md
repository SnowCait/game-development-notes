# ソーシャルゲーム開発

## ディレクトリ構成
* root
  * master
  * api
  * realtime
  * multi
  * batch
  * admin
  * infra
  * document
  * ci
    * Jenkinsfiles

## DB構成
* User (Sharding)
* Game\[, Share, Common\]
* Log (Partition)
* Kpi

### 注意
* 対象範囲が漏れるので `23:59:59` や `BETWEEN` を使わない
  * 必ず `2018-01-01 00:00:00 <= x < 2018-01-02 00:00:00` で比較する

## クライアント
* 解析されることを念頭に置く
  * 本番アプリのコードにデバッグ用コードは含めない `#if DEBUG`
* アセットの容量はファイル毎に管理できるようにしておく

## サーバー
* 個数のあるものは上限（と下限）を設定する。
* ゲーム内通貨もアイテムとして扱った方が楽かも。
* ヘルスチェック用 API を用意しておく
* 複数クライアントバージョン対応
  * API 単位でクライアントのバージョンを基にアクセス権限を調整する仕組み

## 共通
* Swagger 導入
  * API ドキュメント
  * バリデーション

## 要設計
* クライアント/サーバーのコード
  * なるべくクライアントで処理して、サーバーは最低限の更新処理のみ行う
    * メリット：必要な処理を必要な側で行うのでロジックがすっきりする
    * デメリット：ちょっとした修正にストアを通したクライアントの更新が必要になってしまう
  * なるべくサーバーで処理して、クライアントは描画のみを行う
    * メリット：クライアントの更新なしで機能追加やバグ修正ができる
    * デメリット：サーバー負荷が高くなる
* 例外・エラー
* バリデーション
* ログ
  * エラー箇所や原因を特定できるようになっているか
  * 対応しないといけないものだけエラーログに出力する（メンテはエラーログに出さない）
* デバッグコマンド
  * サーバーはデプロイしない or ユーザー判定して弾く
  * クライアントはバイナリいじったら有効にできてしまうのでそもそもコード自体含めない方が良い
* 現在時刻を変更するデバッグコマンド
  * 外部ストレージは影響を受けやすいので注意（ DynamoDB で TTL を設定すると自動削除されるなど）
* 共通コード（親クラスや trait などで作成）
  * ページャ
* メンテナンス運用
  * 定期 or 不定期
  * パーティションで消せない不要データ削除
  * メンテ時に行うアップデートの定義

## 課金設計
### 方針
全てアイテムとして扱う。複数種類のアイテムをセット販売できるようにする。  
効果を即適用したい場合はアイテムとして付与したのち使用させる。

### CSV
`Item.csv`, `Payment.csv`, `Payment_items.csv`

## コミュニケーション
最近はスタンプのみでのコミュニケーションが主流。
* NGワードの設定をしなくてよい
* 出会い系の考慮をしなくてよい
* スタンプを各言語対応することで海外ユーザーとコミュニケーションがとれる

## 機能
* ユーザー
  * 認証
* フォロー（申請あり/なし）
* ギルド
* クエスト
* ミッション
* ログインボーナス
* アイテム
  * ガチャ
  * ショップ
  * 交換所
  * プレゼント
  * 補填
* 装備
  * 保護
* 箱庭
* パーティ
* マルチルーム
* 強化進化
* メンテナンス（ユーザーの権限次第で回避）
* 通知
* 設定
* 4コマ
* ヘルプ
* TIPS（ローディング中に表示されるやつ）

### ゲーム固有でなさそうなもの
* ユーザー
* ガチャ
* アイテム
* 交換所
* プレゼント
* ログインボーナス
* フォロー
* 箱庭
* メンテナンス

### プラットフォーム依存
* 認証
* 課金（ショップ）

## 補填
* 指定期間にログインしたユーザーに配布
  * マスターデータや DB に配布情報を載せてユーザーがログインしたときに配る（これが無駄なデータ増えなくて良さそう）
  * 対象ユーザーを抽出してバッチでプレゼントに積む

## 課金
* ISO 基準の国名コードや通貨コードを使う
* キャッシュはなるべく避けた方がいいかも

## コード自動生成
* 生成されたファイルにコメントで生成元ファイル名を入れておく `Generated by ~`
* コミットフックや CI を利用して自動で実行する
  * 実行に時間がかかるようであれば独立したジョブを用意して push や　merge をトリガーに PR 送る

## 全体
* プロジェクトコードを URL や API などに含めない（基本的にはソースにも書かない）

## テスト
* シャーディングテーブルへのマルチトランザクション

## デバッグ
* API のリクエスト時に `?mode=debug` で受け付けるようにしておくと便利かも（デバッグ環境以外では input のところでエラーにする）

## バグ
* リリース後のバグ修正はお知らせに掲載するかの基準を決めておく
  * お知らせに載せるバグはコミットから自動収集できると望ましい

## ログ
* Kibana, fluentd
* ディレクトリはデプロイ時に予め作成しておく
  * ログ収集ツールからも参照されるのでアプリ側で勝手に作成しない
  * アプリのコードがすっきりする

## ライブラリのアップデート
* アップデートがあった際に RSS から拾って自動的に通知する仕組みを作る
  * GitHub/Redmine/JIRA に Issue を立てる
  * Slack にチャンネルを作って流す
